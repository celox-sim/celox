name: NAPI Build & Publish

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CARGO_INCREMENTAL: "0"

permissions:
  contents: write
  id-token: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            napi-cross: true
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            napi-cross: true
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            zigbuild: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            zigbuild: true
          - target: x86_64-apple-darwin
            os: macos-15
          - target: aarch64-apple-darwin
            os: macos-15
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    name: Build - ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install ziglang (musl targets)
        if: matrix.zigbuild
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Install cargo-zigbuild (musl targets)
        if: matrix.zigbuild
        run: cargo install cargo-zigbuild

      - name: Install dependencies
        working-directory: crates/celox-napi
        run: pnpm install --no-frozen-lockfile

      - name: Build (napi-cross)
        if: matrix.napi-cross
        working-directory: crates/celox-napi
        run: npx napi build --platform --release --manifest-path ../../Cargo.toml -p celox-napi --target ${{ matrix.target }} --use-napi-cross

      - name: Build (zigbuild)
        if: matrix.zigbuild
        working-directory: crates/celox-napi
        run: npx napi build --platform --release --manifest-path ../../Cargo.toml -p celox-napi --target ${{ matrix.target }} -x

      - name: Build (native)
        if: ${{ !matrix.napi-cross && !matrix.zigbuild }}
        working-directory: crates/celox-napi
        run: npx napi build --platform --release --manifest-path ../../Cargo.toml -p celox-napi --target ${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: |
            crates/celox-napi/*.node
            crates/celox-napi/index.js
            crates/celox-napi/index.d.ts
          if-no-files-found: error

  test:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-apple-darwin
            os: macos-15
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    name: Test - ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Download binding artifact
        uses: actions/download-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: crates/celox-napi/

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build packages
        run: pnpm --filter="!@celox-sim/celox-napi" -r build

      - name: Run tests
        run: pnpm -r test

  publish:
    needs: test
    runs-on: ubuntu-latest
    name: Publish
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        working-directory: crates/celox-napi
        run: pnpm install --no-frozen-lockfile

      - name: Set version from tag
        working-directory: crates/celox-napi
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Publishing version: $VERSION"
          npm version "$VERSION" --no-git-tag-version

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: crates/celox-napi/artifacts

      - name: Create npm dirs
        working-directory: crates/celox-napi
        run: npx napi create-npm-dirs

      - name: Sync version to platform packages
        working-directory: crates/celox-napi
        run: npx napi version

      - name: Move artifacts
        working-directory: crates/celox-napi
        run: npx napi artifacts --build-output-dir artifacts

      - name: Copy index files from build artifacts
        working-directory: crates/celox-napi
        run: |
          FIRST_DIR=$(ls -d artifacts/bindings-*/ | head -1)
          cp "$FIRST_DIR/index.js" .
          cp "$FIRST_DIR/index.d.ts" .

      - name: Prepublish
        working-directory: crates/celox-napi
        run: npx napi prepublish -t npm

      - name: List packages
        working-directory: crates/celox-napi
        run: |
          echo "Publishing version: $(node -p "require('./package.json').version")"
          echo "=== Main package ==="
          ls -la index.js index.d.ts *.node
          echo "=== Platform packages ==="
          ls -la npm/*/

      - name: Publish platform packages
        working-directory: crates/celox-napi
        run: |
          for dir in npm/*/; do
            if [ -d "$dir" ]; then
              echo "Publishing $dir..."
              npm publish "$dir" --provenance --access public || true
            fi
          done

      - name: Publish main package
        working-directory: crates/celox-napi
        run: npm publish --provenance --access public

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: crates/celox-napi/artifacts/**/*.node
          generate_release_notes: true

  publish-js:
    needs: publish
    runs-on: ubuntu-latest
    name: Publish JS Packages
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Publishing version: $VERSION"
          (cd crates/celox-napi && npm version "$VERSION" --no-git-tag-version)
          (cd packages/celox && npm version "$VERSION" --no-git-tag-version)
          (cd packages/vite-plugin && npm version "$VERSION" --no-git-tag-version)

      - name: Build packages
        run: pnpm --filter="!@celox-sim/celox-napi" -r build

      - name: Publish @celox-sim/celox
        working-directory: packages/celox
        run: pnpm publish --provenance --access public --no-git-checks

      - name: Publish @celox-sim/vite-plugin
        working-directory: packages/vite-plugin
        run: pnpm publish --provenance --access public --no-git-checks
