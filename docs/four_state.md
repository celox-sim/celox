# 4-State シミュレーション

`veryl-simulator` は IEEE 1800 準拠の 4-state (0, 1, X, Z) シミュレーションをサポートしています。

## 表現モデル

4-state 値は **value/mask ペア** で表現されます。各ビットについて：

| mask | value | 意味 |
|------|-------|------|
| 0    | 0     | `0`  |
| 0    | 1     | `1`  |
| 1    | 0     | `X`  |
| 1    | 1     | 予約（正規化により排除） |

64bit を超える信号はチャンク (`i64 × N`) に分割され、value チャンク列と mask チャンク列のペアとして保持されます（`TransValue::FourState { values, masks }`）。

## 正規化不変条件

**IEEE 1800 正規化: `v &= ~m`**

mask が 1 のビット位置では、対応する value ビットを常に 0 に保ちます。これにより `(mask=1, value=1)` の不正状態を排除し、比較やデバッグ出力の一貫性を保証します。

### 適用箇所

正規化は **`TransValue::FourState` を生成するすべての演算パス** で適用されます。

| 場所 (arith.rs) | 演算 | 幅 |
|-----------------|------|-----|
| Assign (単一チャンク) | 代入・型変換 | ≤ 64bit |
| Assign (マルチチャンク) | 代入・型変換 | > 64bit |
| Binary ops (単一) | 算術・論理・比較・シフト | ≤ 64bit |
| Binary ops (マルチ) | 同上 | > 64bit |
| Unary ops (単一) | ビット反転・否定・リダクション | ≤ 64bit |
| Unary ops (マルチ) | 同上 | > 64bit |
| Concat (単一) | 連結 | ≤ 64bit |
| Concat (マルチ) | 連結 | > 64bit |

### メモリ Load での正規化が不要な理由

`memory.rs` の Load 操作では正規化を行いません。メモリに書き込まれる値は以下のいずれかであり、いずれも正規化済みです：

1. arith.rs の演算結果（上記のとおり正規化済み）
2. 外部 API (`set_four_state`) 経由の入力値

したがって、**メモリ上の値は常に正規化済み**という不変条件が成立し、Load 時の再正規化は不要です。

## X 伝搬ルール

各演算での X（mask）伝搬は IEEE 1800 のセマンティクスに従います。

### ビット演算

| 演算 | mask 計算 | 備考 |
|------|----------|------|
| `a & b` | `(ma \| mb) & ~(~va & ~ma) & ~(~vb & ~mb)` | 確定 0 が X を打ち消す |
| `a \| b` | `(ma \| mb) & ~(va & ~ma) & ~(vb & ~mb)` | 確定 1 が X を打ち消す |
| `a ^ b` | `ma \| mb` | いずれかが X なら X |

### シフト演算

| 条件 | mask 計算 |
|------|----------|
| シフト量が確定 | mask をシフト量だけシフト |
| シフト量に X あり | 結果全体を all-X |

### 算術・比較演算

| 演算 | mask 計算 | 備考 |
|------|----------|------|
| `+`, `-`, `*`, `/`, `%` | いずれかのオペランドに X → 結果全体が all-X | 保守的伝搬 |
| `==`, `!=`, `<`, `>` 等 | 同上（1bit 結果） | |

### Mux (三項演算子)

| 条件 | 動作 |
|------|------|
| セレクタが確定 | 選択された分岐の value/mask を使用 |
| セレクタに X あり | 両分岐の mask を OR した保守的マスク |

### リダクション演算

| 演算 | mask 計算 |
|------|----------|
| `&` (reduction AND) | 確定 0 が存在すれば結果は確定 0、それ以外は X |
| `\|` (reduction OR) | 確定 1 が存在すれば結果は確定 1、それ以外は X |
| `^` (reduction XOR) | いずれかのビットが X なら結果は X |

## 2-state 変数との境界

`bit` 型（2-state）変数にストアする際、mask は強制的に 0 にリセットされます（`memory.rs` のストア後処理）。これにより、2-state 変数を経由した X の意図しない伝搬を防ぎます。

## テストカバレッジ

`tests/four_state.rs` に 4-state 関連テストがあります。
詳細なカバレッジ状況と追加計画は [four_state_test_plan.md](four_state_test_plan.md) を参照してください。
