# シミュレータの最適化アルゴリズム

`veryl-simulator` は、コンパイル時から実行時まで複数の階層で最適化を適用し、シミュレーションの高速化を図っています。

## 1. 論理階層（SLT）の最適化

RTL の論理式を解析する段階で適用される最適化です。

### 1.1 グローバル・ハッシュ・コンシング
同一の論理構造を持つ式（`SLTNode`）を、全モジュール、全 `always_comb` ブロックで共有のインスタンスに集約します。これにより、メモリ使用量の削減と後続のホイスティング効率の向上を実現します。

### 1.2 トポロジカル・ホイスティング
複数回参照される共有部分式を、シミュレーションサイクルの先頭で一度だけ評価するように命令を前方に移動します。冗長な `Load` 命令と演算回数を大幅に削減します。

## 2. 構造階層（SIR）の最適化

生成された命令列（SIR）に対して適用されるパスベースの最適化です。

### 2.1 ロード・ストア結合 (Coalescing)
-   **Load Coalescing**: 同一アドレスの近接したビット範囲への複数回の `Load` を、1 回の広幅 `Load` に統合します。
-   **Store Coalescing**: 同一アドレスへの連続したビット範囲への書き込みを、`Concat` 命令でまとめてから 1 回の `Store` として実行します。

### 2.2 冗長ロード除去 (RLE / Forwarding)
一度レジスタにロードされた値、またはストアした値を追跡し、同一アドレスへの再ロードを削除して既存のレジスタ値を再利用します。

### 2.3 Commit 最適化
-   **Commit Sinking**: 合流ブロックにある `Commit` 命令を、前段の `Store` 命令へ押し下げて統合します。
-   **Inline Forwarding**: 生成された `Commit` 命令を可能な限り `Store` 命令に直接置換し、バッファ間の不要なコピーを削除します。

### 2.4 デッドストア削除
参照されないワーク領域への書き込みを検出し、削除します。

### 2.5 命令スケジューリング
命令間の依存関係 (RAW/WAR/WAW) を保ちつつ、プロセッサの実行ポートやメモリレイテンシを考慮して命令順を再配置します。

## 3. 実行階層（Behavioral）の最適化

シミュレータの実行ループにおいて適用される動的な最適化です。

### 3.1 サイレントエッジのスキップ
クロック信号などのイベントが発生しても、信号値に変化がない場合、またはトリガー条件（立ち上がり/立ち下がり）を満たさない場合、依存する FF の評価とそれに関連する組合せ回路の再評価をスキップします。

### 3.2 マルチフェーズ評価（評価と更新の分離）
複数イベントが同時にトリガーされた際、すべての評価を現時点の Stable 領域の値に基づいて行い、その後に一斉更新を行うことで、イベント発生順序に依存しない一貫したシミュレーション結果を保証します。
